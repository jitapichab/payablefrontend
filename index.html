<!DOCTYPE html>
<html>

<body>
    <img id="loader" src="https://loading.io/spinners/double-ring/lg.double-ring-spinner.gif">
    <script src="./node_modules/web3/dist/web3.min.js"></script>

    <h1> Example Paylable dapp etheruem  </h1>
    

    <h2> harvest money from the contract:</h2><br>
    <input type="text" name="harvest" id="collectmoneycontract" class="form-control">
    <input type="submit" value="collect" id="collect" class="btn btn-default"> <br>
    <label id="collectlabelmoney"> Tx Collect Money </label>
    <br>

    <h2> verify money in the contract:</h2><br>
    <input type="submit" value="verify" id="verify" class="btn btn-default"> <br>
    <label id="verifimoney"> Balance Contract in Wei> </label>
    <br>


    <h3> transfer money to the contract </h3>
    <input type="text" name="pagar contrato" id="transferiracontrato" class="form-control"><br>
    <input type="submit" value="transferir" id="transfermony" class="btn btn-default"> <br>
    <label id="transferlabelmoney"> Tx transfer money </label>
    <br> <br>

    <input type="submit" class="btn btn-info" value="Filtrar logs" id="filterlogs">

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <script>
        if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
        } else {
           web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
        }
        web3.eth.defaultAccount = web3.eth.accounts[0];
        
    var    contract_abidefinition='[{"constant":false,"inputs":[{"name":"fecha","type":"string"}],"name":"PagarMas","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":true,"inputs":[],"name":"AcumuladoContrato","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"amount","type":"uint256"},{"name":"fecha","type":"string"}],"name":"Cobrar","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":true,"stateMutability":"payable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"name":"pagador","type":"address"},{"indexed":true,"name":"fecha","type":"string"},{"indexed":false,"name":"cantidad","type":"uint256"}],"name":"QuienPago","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"cobrador","type":"address"},{"indexed":true,"name":"fecha","type":"string"},{"indexed":false,"name":"cantidad","type":"uint256"}],"name":"QuienCobro","type":"event"}]';
    var    abiDefinition= JSON.parse(contract_abidefinition);
    // crear objeto de tipo contrato con el json
    var contract = web3.eth.contract(abiDefinition);
    var instance= contract.at("0xf64931a03D7ce81c250c3572AbB62b247B963b71");
    console.log(instance);
    $("#loader").hide();
    var fecha=new Date();
    fecha= fecha.toString();
    console.log(fecha);
    
    $("#collect").click(function() {
        console.log("ingreso una vez ");
        $("#loader").show();
        var value=$('#collectmoneycontract').val();
        instance.Cobrar(value,fecha,(err,res)=>{ 
            if (!err) {
            $("#loader").hide();
            }
            else {
                $("#loader").hide();
                alert(err);
               
            }
        });
    
      });

      $("#verify").click(function() {
        console.log("verificar");
        $("#loader").show();
        instance.AcumuladoContrato((err,res)=>{ 
            if (err) {
                alert("ocurrio un error!");
            }
            else {
                alert(res);
            }
            $("#loader").hide();});
    
      });

      $("#transfermony").click(function() {
        console.log("verificar");
        $("#loader").show();
        var valor=$('#transferiracontrato').val();
        console.log(valor);
        instance.PagarMas(fecha,{
            // from: web3.eth.defaultAccount,
             value: web3.toWei(valor, 'ether'), 
           },(err,res)=>{ 
              if (!err) {
                  alert("la transacci√≥n es:" +res);
            $("#loader").hide();
              }
              else {
                $("#loader").hide();
                  alert(err);
              }      
        });
    
      });

      $("#filterlogs").click(function(){
        console.log("se pulso boton filtrar logs!");

        var events = instance.allEvents({fromBlock: 0, toBlock: 'latest'});
        events.watch(function(err, res){
        if (!error){
            console.log(result);
        }
        else {
            console.log(err);
        }
    
});

      });

      // evento apenas se recarga la pagina
      window.onload = function() {  
        console.log("se cargo la pagina"); 
        
        
      };







    </script>


</body>
</html>