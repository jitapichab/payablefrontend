<!DOCTYPE html>
<html>

<body>
    <img id="loader" src="https://loading.io/spinners/double-ring/lg.double-ring-spinner.gif">
    <script src="./node_modules/web3/dist/web3.min.js"></script>

    <div class="jumbotron text-center">
        <h1>Example  etheruem blockchain </h1>
        <p>Transactions, calls, logs and events!</p> 
        <img src="./images/etheruemicon.png" alt="Mountain View" height="147" width="91">
    </div>
    
    <h2>harvest money from the contract: <span class="label label-default">Push the botton!</span></h2> <br>
    <div class="row">
        <div class="col-lg-4 col-lg-offset-4">
            <div class="input-group">
                <input type="text" class="form-control" id="collectmoneycontract" > 
                <span class="input-group-btn">
                    <button class="btn btn-default" type="button" id="collect"  >Collect!</button>
                </span>
            </div><!-- /input-group -->
        </div><!-- /.col-lg-4 -->
    </div><!-- /.row -->


    <h2>Verify money in  the contract: <span class="label label-primary">Push the botton!</span></h2> <br>
   
    <div class="col-lg-4 col-lg-offset-4">
        <button class="btn btn-default center-block col-lg-12" type="button" id="verify"  >Verify!</button> 
    </div>         
     <br>

    <h2>Transfer money to the contract <span class="label label-success">Push the botton!</span></h2> <br>
    <div class="row">
        <div class="col-lg-4 col-lg-offset-4">
            <div class="input-group">
                <input type="text" class="form-control" id="transferiracontrato" > 
                <span class="input-group-btn">
                    <button class="btn btn-default" type="button" id="transfermony"  >Transfer!</button>
                </span>
            </div><!-- /input-group -->
        </div><!-- /.col-lg-4 -->
    </div><!-- /.row -->
   
    <br> <br> <br>
     
    <div class="container"> 
        <input type="submit" class="btn btn btn-default col-md-3" value="Filtrar logs" id="filterlogs">
        <input type="submit" class="btn btn-primary col-md-3" value="Filtrar logs" id="filterlogs">
        <input type="submit" class="btn btn-info col-md-3" value="Filtrar logs" id="filterlogs">
        <input type="submit" class="btn btn-success col-md-3" value="Filtrar logs" id="filterlogs">
    </div>

    <div class="container">
        <h2>Basic Table</h2>
        <p>The .table class adds basic styling (light padding and only horizontal dividers) to a table:</p>            
        <table class="table">
          <thead>
            <tr>
              <th id="firstcolumn">Firstname</th>
              <th>Lastname</th>
              <th>Email</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>John</td>
              <td>Doe</td>
              <td>john@example.com</td>
            </tr>
            <tr>
              <td>Mary</td>
              <td>Moe</td>
              <td>mary@example.com</td>
            </tr>
            <tr>
              <td>July</td>
              <td>Dooley</td>
              <td>july@example.com</td>
            </tr>
          </tbody>
        </table>
      </div>
      




    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="./js/bignumber.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <script>
            $("#firstcolumn").text("prueba");
        if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
        } else {
           web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
        }
        web3.eth.defaultAccount = web3.eth.accounts[0];
        
    var    contract_abidefinition='[{"constant":false,"inputs":[{"name":"fecha","type":"string"}],"name":"PagarMas","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":true,"inputs":[],"name":"AcumuladoContrato","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"amount","type":"uint256"},{"name":"fecha","type":"string"}],"name":"Cobrar","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":true,"stateMutability":"payable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"pagador","type":"address"},{"indexed":false,"name":"fecha","type":"string"},{"indexed":false,"name":"cantidad","type":"uint256"}],"name":"QuienPago","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"cobrador","type":"address"},{"indexed":false,"name":"fecha","type":"string"},{"indexed":false,"name":"cantidad","type":"uint256"}],"name":"QuienCobro","type":"event"}]';
    var    abiDefinition= JSON.parse(contract_abidefinition);
    // crear objeto de tipo contrato con el json
    var contract = web3.eth.contract(abiDefinition);
    var instance= contract.at("0x654d9E07C49a4ab6E14681F02f26F24305FC50A7");
    console.log(instance);
    $("#loader").hide();
    var fecha=new Date();
    fecha= fecha.toString();
    console.log(fecha);
    
    $("#collect").click(function() {
        console.log("ingreso una vez ");
        $("#loader").show();
        var value=$('#collectmoneycontract').val();
        instance.Cobrar(value,fecha,(err,res)=>{ 
            if (!err) {
            $("#loader").hide();
            $("#collectlabelmoney").text(res);
            }
            else {
                $("#loader").hide();
                alert(err);
               
            }
        });
    
      });

      $("#verify").click(function() {
        console.log("verificar");
        $("#loader").show();
        instance.AcumuladoContrato((err,res)=>{ 
            if (err) {
                alert("ocurrio un error!");
            }
            else {
                alert(res);
            }
            $("#loader").hide();});
    
      });

      $("#transfermony").click(function() {
        console.log("verificar");
        $("#loader").show();
        var valor=$('#transferiracontrato').val();
        console.log(valor);
        instance.PagarMas(fecha,{
            // from: web3.eth.defaultAccount,
             value: web3.toWei(valor, 'ether'), 
           },(err,res)=>{ 
              if (!err) {
                  alert("la transacci√≥n es:" +res);
            $("#loader").hide();
              }
              else {
                $("#loader").hide();
                  alert(err);
              }      
        });
    
      });

      $("#filterlogs").click(function(){
        console.log("se pulso boton filtrar logs!");

        var events = instance.allEvents({ fromBlock:1, toBlock: "latest" });
      
         events.get(function(error, logs){
          if(error){
              console.log('GET Error:',error);
              
          } else {
              console.log(logs);
              for(i=0;i<logs.length;i++)
             {
                console.log(logs[i].blockNumber);
                console.log(logs[i].args.cantidad.c[0]);
                  
             }    

          }
      
        });

    });

      // evento apenas se recarga la pagina
      window.onload = function() {  
        console.log("se cargo la pagina"); 
        
        
      };







    </script>


</body>
</html>